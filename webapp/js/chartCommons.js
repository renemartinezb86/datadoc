define([],function(){function getFullName(s){var name=s.name;return s.operation&&!s.renamed&&(name+=' ('+s.op.name+')'),name}function getAggIndex(groups,aggs){var aggIndex=0;return groups.length&&(aggIndex=_.findIndex(aggs,{field:groups[0].field}),0>aggIndex&&(aggIndex=0)),aggIndex}function activateTooltip($scope,$timeout,p){if($scope.chartTooltip.resetTimeout(),!p.options.otherChart){var field,result=p.o;field='$$row_number'==$scope.vizSummary.xAxisShows[0].key?this.options.key||this.options.name.toLowerCase():$scope.vizSummary.xAxisShows[0].key;var key;$scope.gridApi&&(key=_.find($scope.gridApi.grid.columns,{field:field})),$scope.chartTooltip.color=p.color,$scope.chartTooltip.point=p,$scope.chartTooltip.active=!0,$scope.chartTooltip.viewData=!1,$scope.chartTooltip.byColumn=key,$scope.chartTooltip.byValue=result[field],$scope.chartTooltip.row=key?void 0:{entity:p.o},$scope.chartTooltip.values=_.map($scope.gridOptions.columnDefs,function(col){var value=p.o[col.name];return{name:col.displayName,value:value}}),$scope.chartTooltip.isRegressionLine=$scope.vizSummary.chartType===CHART_TYPES.SCATTER&&'spline'===p.series.userOptions.type,$scope.chartTooltip.headerData=[{key:p.name||p.series.name,value:p.y}],$scope.chartTooltip.activateVisible(),$scope.chartTooltip.activateEvents(),$scope.$apply(),$timeout(function(){$scope.chartTooltip.updatePosition(p)})}}var CHART_TYPES={COLUMN:0,BAR:1,PIE:2,LINE:3,AREA:4,MAP:5,SCATTER:6,TABLE:7,LIST:8},REGRESSION_TYPES={LINEAR:0,EXPONENTIAL:1,LOGARITHMIC:2,POWER:3,POLYNOMIAL:4},REGRESSION_TYPE_OPTIONS=[{desc:'Linear',value:REGRESSION_TYPES.LINEAR},{desc:'Exponential',value:REGRESSION_TYPES.EXPONENTIAL},{desc:'Logarithmic',value:REGRESSION_TYPES.LOGARITHMIC},{desc:'Power',value:REGRESSION_TYPES.POWER},{desc:'Polynomial',value:REGRESSION_TYPES.POLYNOMIAL}];return{CHART_TYPES:CHART_TYPES,REGRESSION_TYPES:REGRESSION_TYPES,REGRESSION_TYPE_OPTIONS:REGRESSION_TYPE_OPTIONS,getFullName:getFullName,getAggIndex:getAggIndex,defaultChartOptions:function(rawData,$scope,$timeout,$filter,activeClick){return{chart:{renderTo:'chart-container',events:{load:function load(){$scope.expandOnDrillDown||($scope.inRequestViz=!1)},click:function click(e){activeClick&&$scope.chartType!=$scope.chartTypes.SCATTER||!$scope.chartTooltip.active&&this.hoverPoint&&(e.stopPropagation(),activateTooltip.bind(this.hoverSeries,$scope,$timeout,this.hoverPoint)())}},resetZoomButton:{theme:{fill:'#f8f8f8',stroke:'#ccc',style:{color:'#333'},r:1,states:{hover:{fill:'#e7e7e7',stroke:'#adadad',style:{color:'black',cursor:'pointer'}}}}}},exporting:{enabled:!1},title:{text:'',style:{display:'none'}},subtitle:{text:'',style:{display:'none'}},plotOptions:{series:{point:{events:{mouseOver:function mouseOver(e){if(!$scope.chartTooltip.active){$scope.chartTooltip.resetTimeout(),$scope.chartTooltip.value=null;var p=e.target,data=[],type=rawData?rawData.vizSummary.chartType:$scope.vizSummary.chartType,mainValueKey=rawData?rawData.vizSummary.xAxisShows[0].field:$scope.vizSummary.xAxisShows[0].field;if(type===CHART_TYPES.PIE)data.push({key:type===CHART_TYPES.PIE?p.name:p.series.name,value:p.y});else if(type===CHART_TYPES.SCATTER){var category=p.index;p.series.chart.series.forEach(function(item){'Navigator'!=item.name&&item.data.length&&item.data[category]&&item.data[category].y&&data.push({value:item.data[category].y,key:item.name,color:item.color})}),$scope.chartTooltip.value=p.category}else{if(rawData?rawData.segmentBy.length:$scope.vizSummary.segmentBy.length){var key=rawData?rawData.yAxisShows[0].key:$scope.vizSummary.yAxisShows[0].key,category=p.category;p.series.chart.series.forEach(function(item){'Navigator'!=item.name&&item.data[category].options.y&&data.push({value:item.data[category].options.y,key:item.name,color:item.color})})}else{var shows=rawData?rawData.yAxisShows.slice(0,6):$scope.vizSummary.yAxisShows.slice(0,6);shows.forEach(function(el){var searchName=(rawData?rawData.aggs.length:$scope.dataSummary.aggs.length)?getFullName(el):el.name,color=_.find(p.series.chart.series,{name:searchName});color&&(color=color.color);var filter=_.find($scope.gridOptions.columnDefs,{field:el.key});filter&&(filter=filter.customFilter);var value;value=p.o[el.key],data.push({value:value,key:el.showName,color:color})})}$scope.chartTooltip.value='$$row_number'==mainValueKey?p.category:p.o[mainValueKey],$scope.chartTooltip.value||($scope.chartTooltip.value=p.o.aggregation)}$scope.chartTooltip.headerData=data,$scope.chartTooltip.color=e.target.color,$scope.chartTooltip.deactivateEvents(),$scope.chartTooltip.activateVisible(),$scope.$apply(),$timeout(function(){$scope.chartTooltip.updatePosition(e.target)})}}}},events:{click:function click(e){activeClick&&$scope.chartType!=$scope.chartTypes.SCATTER&&'visualizationCtrl'!=$scope.controllerName||(e.stopPropagation(),activateTooltip.bind(this,$scope,$timeout,e.point)())},mouseOut:function mouseOut(){$scope.chartTooltip.active||($scope.chartTooltip.hidePromise=$timeout(function(){$scope.chartTooltip.hide()},250))}}}},xAxis:{labels:{formatter:function formatter(){if((rawData||!$scope.popupData||!$scope.popupData.is)&&$scope.gridApi){var vr=[];rawData||(rawData={vizSummary:{},dataSummary:{},empty:!0},$scope.gridApi&&(vr=$scope.gridApi.core.getVisibleRows()));var d={xAxisShows:rawData.vizSummary.xAxisShows||$scope.vizSummary.xAxisShows,chartType:rawData.vizSummary.chartType||$scope.vizSummary.chartType,columnDefs:$scope.gridOptions.columnDefs,data:vr.length?_.map(vr,'entity'):$scope.gridOptions.data,aggs:rawData.dataSummary.aggs||$scope.dataSummary.aggs};if(rawData.empty&&(rawData=null),d.xAxisShows[0]){var type,val,key=d.xAxisShows[0].field;if('$$row_number'==key||d.chartType==CHART_TYPES.SCATTER)val=this.value;else{if(!_.find(d.columnDefs,{field:key})&&!_.find(d.aggs,{field:key}))return;type=0==d.aggs.length?_.find(d.columnDefs,{field:key}).type:_.find(d.aggs,{field:key}).type;var aggIndex=getAggIndex(d.xAxisShows,d.aggs),allData=_.filter(d.data,function(o){return o.__treeLevel==aggIndex}),data=allData[this.value];if(data)if(val=data.aggregation||data[key],null==val)val='null';else if('daterange'===type){var operation=d.xAxisShows[0].operation;val=operation&&'year'==operation?$filter('date')(data[d.xAxisShows[0].key],'y'):$filter('date')(val,'MMM d, y')}}return val}}}}},navigator:{series:{includeInCSVExport:!1},xAxis:{labels:{formatter:function formatter(){return''}}}},rangeSelector:{enabled:!1},legend:{enabled:!0,useHTML:!0},yAxis:{},series:[],credits:{enabled:!1},tooltip:{enabled:!1}}},chartTooltip:function(rawData,$scope,$timeout,modalClass){return{visible:!1,active:!1,isEnableEvents:!0,viewData:!1,point:null,byColumn:null,byValue:null,color:null,headerData:[],hidePromise:null,direction:null,showData:function showData(){$scope.chartTooltip.viewData=!0,$timeout(function(){$scope.chartTooltip.popup&&$scope.chartTooltip.popup.update()})},closeData:function closeData(){$scope.chartTooltip.viewData=!1,$timeout(function(){$scope.chartTooltip.popup&&$scope.chartTooltip.popup.update()})},hide:function hide(){if(this.visible){var that=this;$timeout(function(){that.visible=!1,that.active=!1})}},updatePosition:function updatePosition(point){var chartContainer=$('#chart-container'),offset=chartContainer.offset(),tooltip=$('.chart-tooltip'),left=offset.left+(point.tooltipPos?point.tooltipPos[0]:point.plotX),top=offset.top+(point.tooltipPos?point.tooltipPos[1]:point.plotY),arrowLeftPosition=tooltip.width()/2-10;if(point.series){left+=point.series.chart.plotLeft-10,(rawData?rawData.chartType:$scope.vizSummary.chartType)===CHART_TYPES.BAR?(left-=tooltip.width()/2-10,top=top-tooltip.height()+22,!rawData&&$scope.vizSummary.enabledMultiAxis&&(top+=point.series.chart.plotTop-40)):(left-=tooltip.width()/2-8,top=top-tooltip.height()-10);var leftOutside=left+tooltip.width()-(chartContainer.width()+offset.left),rightOutside=offset.left-left;if(0<leftOutside?(left-=leftOutside,arrowLeftPosition+=leftOutside):0<rightOutside&&(left+=rightOutside,arrowLeftPosition-=rightOutside),top<tooltip.height()?(top+=tooltip.height()+35,this.direction='top'):this.direction='bottom',modalClass){var modalOffset=$(modalClass+' .modal-body').offset();left-=modalOffset.left,top-=modalOffset.top-65}tooltip.css({left:left,top:top}),$('.chart-tooltip .arrow').css({left:arrowLeftPosition})}},activateEvents:function activateEvents(){this.isEnableEvents||($('.chart-tooltip').css('pointer-events','auto'),this.isEnableEvents=!0)},deactivateEvents:function deactivateEvents(){this.isEnableEvents&&($('.chart-tooltip').css('pointer-events','none'),this.isEnableEvents=!1)},activateVisible:function activateVisible(){this.visible||(this.visible=!0)},resetTimeout:function resetTimeout(){this.hidePromise&&$timeout.cancel($scope.chartTooltip.hidePromise)}}},isAllowedDataForChartType:function(type,$scope,colsTypes){var groups=_.filter($scope.vizSummary.xAxisShows,function(s){return'$$row_number'!=s.field}),cols=$scope.vizSummary.yAxisShows;switch(type){case CHART_TYPES.COLUMN:return!0;case CHART_TYPES.BAR:return!0;case CHART_TYPES.LINE:return!0;case CHART_TYPES.AREA:return!0;case CHART_TYPES.PIE:return 0<groups.length;case CHART_TYPES.MAP:if(0<groups.length&&!$scope.vizSummary.hltd){var field=colsTypes[groups[0].field].toLowerCase();return'location_lat_lon'==field||!field.indexOf('location')}return!1;case CHART_TYPES.SCATTER:return 1==groups.length&&1==cols.length&&!$scope.vizSummary.hltd;case CHART_TYPES.TABLE:case CHART_TYPES.LIST:return!0;default:throw'Unknown chart type: '+type;}},calculateCoordsForRegressions:function(data,regressionType,regData,allData){function calculateY(equation,x,i){var _Mathpow=Math.pow;return regressionType===REGRESSION_TYPES.LINEAR?0==i?minY:minY+=plusY:regressionType===REGRESSION_TYPES.EXPONENTIAL?equation[0]*Math.exp(equation[1]*x):regressionType===REGRESSION_TYPES.LOGARITHMIC?equation[0]+equation[1]*Math.log(x):regressionType===REGRESSION_TYPES.POWER?equation[0]*_Mathpow(x,equation[1]):regressionType===REGRESSION_TYPES.POLYNOMIAL?equation[2]*_Mathpow(x,2)+equation[1]*x+equation[0]:void 0}var minY=data[0].y,maxY=data[data.length-1].y,plusY=(maxY-minY)/data.length,minX=data[0].x,maxX=data[data.length-1].x,plusX=(maxX-minX)/data.length,forCalc=JSON.stringify({string:regData.string,equation:regData.equation,type:regressionType});return{name:regData.string+' R\xB2='+regData.r2.toFixed(2)+' <a onclick=\'$scope.regressionCalculator(event, '+JSON.stringify(forCalc)+')\'>Calculate</a>',type:'spline',data:_.map(data,function(o,i){return{x:parseFloat((0==i?minX:minX+=plusX).toFixed(2)),y:parseFloat(calculateY(regData.equation,minX,i).toFixed(2)),o:allData[i]}}).concat([{x:parseFloat((minX+=plusX).toFixed(2)),y:parseFloat(calculateY(regData.equation,minX,data[data.length]).toFixed(2)),o:allData[allData.length-1]}])}},removeCalculate:function(str){var startIndex=str.indexOf('<a onclick=\'$scope.regressionCalculator'),endIndex=str.indexOf('Calculate</a>');return-1!=startIndex&&-1!=endIndex&&(str=str.slice(0,startIndex)),str}}});
//# sourceMappingURL=maps/chartCommons.js.map
