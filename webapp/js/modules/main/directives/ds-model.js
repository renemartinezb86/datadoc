define(['./module','common','lodash','joint','angular','angular-sortable-view','ui-grid-move-columns'],function(directives,common,_,joint,angular){'use strict';directives.directive('dsModel',['$http','$location','$filter','$compile','$q','$sce','$templateCache','$templateRequest','$timeout','$uibModal','HistoryService','WSocket','$localStorage','DatadocService','$state','$stateParams','gridUtil','uiGridColumnMenuService',function($http,$location,$filter,$compile,$q,$sce,$templateCache,$templateRequest,$timeout,$uibModal,HistoryService,WSocket,$localStorage,DatadocService,$state,$stateParams){var ViewType={TABLE:0,LIST:1,NESTED:2},fromHistory=!1;return{restrict:'A',templateUrl:'static/templates/include/ds-model.html',link:function link($scope,$elm){function startFlowStatePolling(taskId){$scope.currentTask=taskId,$http.post('/api/flow/get_state',{taskId:taskId}).success(function(task){$scope.flowExecutionState=task.result;var step=0,steps=0;_.each(graph.getElements(),function(cell){if(task.result&&task.result.state){var node=task.result.state[cell.id];if(steps++,node){var view=cell.findView(paper);if('FINISHED'==node.state)view.$box.addClass('finished'),$scope.progressBar.remainingStr='',step++;else if('RUNNING'!=node.state)view.$box.removeClass('running');else if(view.$box.addClass('running'),_.contains(['html.OutputNode','html.JoinNode'],cell.get('type'))){var complete=node.percentComplete?node.percentComplete.toFixed(0):0;$scope.progressBar.value=complete}}}}),step<steps&&step++,$scope.progressBar.step=step,$scope.progressBar.steps=steps,task.finished?$http.get('/api/tables/'+$scope.selectedTable.id).success(function(data){var indexes=DatadocService.getList(),indexToUpdate=_.findIndex(indexes,{id:data.id});indexToUpdate?indexes.splice(indexToUpdate,1,data):DatadocService.push(data),$timeout(function(){if(task.statistics.lastErrorRootCauseMessage){$scope.dsErrorTask=task;var content=$compile(angular.element('<div>{{dsErrorTask.statistics.lastErrorRootCauseMessage | limitTo : 100}}<br/>'+'<a ng-click=\'showDsErrorModal()\'>Details...</a></div>'))($scope);common.showNotification(content[0],'error',0)}else $scope.progressBar.isFinished=!0;$scope.isCommitRunning=!1,$scope.isCancelRunning=!1,$scope.progressBar.step=0,$scope.progressBar.steps=0,$scope.progressBar.value=0,$scope.selectedTable.committed=new Date,_.each(graph.getElements(),function(cell){var view=cell.findView(paper);view.$box.removeClass('finished'),view.$box.removeClass('running')})})}):$timeout(function(){startFlowStatePolling(taskId)},2e3)}).error(common.showError)}function pushDeleteLinkEvent(item){HistoryService.push({redo:function redo(){item.remove(),$scope.api.onChange()},undo:function undo(){addToGraph(item).then(function(){$scope.api.onChange()})}})}function pushDeleteNodeEvent(item){HistoryService.push({redo:function redo(){$scope.selectedNode&&item.cid==$scope.selectedNode.model.cid&&removeHighlight(),item.remove(),$scope.api.onChange()},undo:function undo(){addToGraph(item).then(function(){$scope.api.onChange()})}})}function pushEditJoinSettingsEvent(item,lastSettings,currentSettings){HistoryService.push({undo:function undo(){item.set('settings',lastSettings),$scope.api.onChange()},redo:function redo(){item.set('settings',currentSettings),$scope.api.onChange()}})}function pushMoveNodeEvent(item,lastCellPosition,currentCellPosition){HistoryService.push({undo:function undo(){item.model.position(lastCellPosition.x,lastCellPosition.y),addHighlight(item)},redo:function redo(){item.model.position(currentCellPosition.x,currentCellPosition.y),addHighlight(item)}})}function pushAddNodeEvent(items){items=_.isArray(items)?_.filter(items,function(item){return'html.OutputNode'!=item.get('type')}):[items],HistoryService.push({undo:function undo(){_.each(items,function(item){item.remove()})},redo:function redo(){_.each(items,function(item){addToGraph(item).then(function(){$scope.api.onChange()})})}})}function pushDisableFacets(settings){HistoryService.push({redo:function redo(){settings.disableFacets=!settings.disableFacets,$scope.api.preview()},undo:function undo(){settings.disableFacets=!settings.disableFacets,$scope.api.preview()}})}function pushSetAsPk(oldPkeyCol,newPkeyCol){HistoryService.push({redo:function redo(){if(!newPkeyCol.pkey){var columns=$scope.selectedNode.model.get('settings').columns;_.each(columns,function(column){column.pkey=!1})}newPkeyCol.pkey=!newPkeyCol.pkey,$scope.api.preview()},undo:function undo(){var columns=$scope.selectedNode.model.get('settings').columns;_.each(columns,function(column){column.pkey=!1}),oldPkeyCol&&(oldPkeyCol.pkey=!oldPkeyCol.pkey),$scope.api.preview()}})}function pushRemoveErrors(colName){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.removeErrors=!settings.removeErrors,$scope.api.preview()},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.removeErrors=!settings.removeErrors,$scope.api.preview()}})}function pushCoerceToType(colName,oldType,newType){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.filter=null,settings.formatSymbol=null,settings.decimalPlaces=null,'function'==typeof newType?newType(settings):(settings.type=newType,$scope.api.preview())},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.filter=null,settings.formatSymbol=null,settings.decimalPlaces=null,'function'==typeof oldType?oldType(settings):(settings.type=oldType,$scope.api.preview())}})}function pushSetDataFormat(colName,oldData,newData){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.filter=newData.filter,settings.decimalPlaces=newData.decimalPlaces,refreshPreviewFromCache()},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.filter=oldData.filter,settings.decimalPlaces=oldData.decimalPlaces,refreshPreviewFromCache()}})}function pushUpdatePreviewFormat(colName,oldFormat,newFormat){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.formatSymbol=newFormat.formatSymbol,settings.decimalPlaces=newFormat.decimalPlaces,settings.filter=newFormat.filter,refreshPreviewFromCache()},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.formatSymbol=oldFormat.formatSymbol,settings.decimalPlaces=oldFormat.decimalPlaces,settings.filter=oldFormat.filter,refreshPreviewFromCache()}})}function pushUpdateColumnName(oldColName,newColName){HistoryService.push({redo:function redo(){var column=_.find($scope.gridApi.grid.columns,{displayName:oldColName});column.edited=!1;var columnSettings=_.find($scope.selectedNode.model.get('settings').columns,{name:column.colDef.originalName});columnSettings.rename=newColName,column.displayName=newColName,$scope.api.preview()},undo:function undo(){var column=_.find($scope.gridApi.grid.columns,{displayName:newColName});column.edited=!1;var columnSettings=_.find($scope.selectedNode.model.get('settings').columns,{name:column.colDef.originalName});columnSettings.rename=oldColName,column.displayName=oldColName,$scope.api.preview()}})}function pushUpdatePreviewAnnotation(colName,oldAnnotaion,newAnnotaion){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.annotation=newAnnotaion,refreshPreviewFromCache()},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.annotation=oldAnnotaion,refreshPreviewFromCache()}})}function pushUpdateReplaceErrors(colName,oldReplace,newReplace){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.replaceErrors=newReplace,$scope.api.preview()},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.replaceErrors=oldReplace,$scope.api.preview()}})}function pushDeleteReplaceErrors(colName,oldReplace,newReplace){HistoryService.push({redo:function redo(){var settings=getCurrentSettingsByName(colName);settings.replaceErrors=newReplace,$scope.api.preview()},undo:function undo(){var settings=getCurrentSettingsByName(colName);settings.replaceErrors=oldReplace,$scope.api.preview()}})}function pushAddTransform(item,index){HistoryService.push({redo:function redo(){$scope.isIndexChanged||($scope.isIndexChanged=!0),$scope.transformHistory.push(item),fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory),$scope.api.preview()},undo:function undo(){$scope.isIndexChanged||($scope.isIndexChanged=!0),$scope.transformHistory.splice(index,1),fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory),$scope.api.preview()}})}function pushDeleteTransform(item,index){HistoryService.push({redo:function redo(){$scope.isIndexChanged||($scope.isIndexChanged=!0),$scope.transformHistory.splice(index,1),fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory),$scope.api.preview()},undo:function undo(){$scope.isIndexChanged||($scope.isIndexChanged=!0),$scope.transformHistory.push(item),fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory),$scope.api.preview()}})}function pushEndSortFieldsGrid(oldPos,newPos){HistoryService.push({redo:function redo(){fromHistory=!0,$scope.gridApi.colMovable.moveColumn(oldPos,newPos)},undo:function undo(){fromHistory=!0,$scope.gridApi.colMovable.moveColumn(newPos,oldPos)}})}function pushEndResizeColumn(colName,deltaChange){HistoryService.push({redo:function redo(){fromHistory=!0;var column=_.find($scope.gridApi.grid.columns,{displayName:colName});column.width+=deltaChange,column.hasCustomWidth=!0,$scope.gridApi.core.refresh(),$scope.gridApi.grid.refresh()},undo:function undo(){fromHistory=!0;var column=_.find($scope.gridApi.grid.columns,{displayName:colName});column.width+=~deltaChange+1,column.hasCustomWidth=!0,$scope.gridApi.core.refresh(),$scope.gridApi.grid.refresh()}})}function pushSelectNode(oldNode,newNode){HistoryService.push({redo:function redo(){if(newNode){var sourceView;if('html.OutputNode'==newNode.model.get('type')){var link=graph.getConnectedLinks(newNode.model,{inbound:!0})[0];link&&(sourceView=paper.findViewByModel(graph.getCell(link.get('source').id)))}$scope.selectedNode=sourceView||newNode;var updatePreview=null==actualSelectedNode||newNode.model.id!=actualSelectedNode.model.id;actualSelectedNode=newNode,newNode.model.toFront(),updatePreview&&(removeHighlight(),addHighlight(newNode),'html.OutputNode'!=$scope.selectedNode.model.get('type')&&($scope.transformHistory=$scope.selectedNode.model.get('settings').transforms,fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory)),$scope.api.preview())}},undo:function undo(){if(oldNode){var sourceView;if('html.OutputNode'==oldNode.model.get('type')){var link=graph.getConnectedLinks(oldNode.model,{inbound:!0})[0];link&&(sourceView=paper.findViewByModel(graph.getCell(link.get('source').id)))}$scope.selectedNode=sourceView||oldNode;var updatePreview=null==actualSelectedNode||oldNode.model.id!=actualSelectedNode.model.id;actualSelectedNode=oldNode,oldNode.model.toFront(),updatePreview&&(removeHighlight(),addHighlight(oldNode),'html.OutputNode'!=$scope.selectedNode.model.get('type')&&($scope.transformHistory=$scope.selectedNode.model.get('settings').transforms,fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory)),$scope.api.preview())}}})}function createInputSource(u,position){var type,settings;return indexUploads[u.id]=u,'folder'==u.type?(type=joint.shapes.html.UnionFolderNode,settings={"@class":'.UnionFolderNodeSettings',folderId:u.id,transforms:[],columns:[]}):(type=joint.shapes.html.InputNode,settings={"@class":'.InputNodeSettings',uploadId:u.id,transforms:[],columns:[]}),createItem(type,{label:u.name},settings,{position:position,outPorts:['out']})}function createItem(itemType,view,settings,opts){var options=_.merge({position:{x:100+delta,y:100+delta},size:{width:75,height:75},view:view,settings:settings,z:delta},opts);return delta+=20,150<delta&&(delta=0),new itemType(options)}function addToGraph(item){var hasOutput=_.find(graph.getElements(),function(e){return'html.OutputNode'==e.get('type')}),emtpyGraph=0==graph.getElements().length,isInput='html.InputNode'==item.get('type');return $timeout(function(){if(item.addTo(graph),item.toFront(),isInput&&!hasOutput){var outPosition={x:item.position().x+outputNodeOffsetX,y:item.position().y};return $scope.api.nodes.addOutput(outPosition,$scope.selectedTable.id).then(function(out){if(emtpyGraph){var link=new joint.shapes.html.Link({source:{id:item.id,port:'out'},target:{id:out.id,port:'in1'}});return graph.addCell(link),$scope.api.onChange(),[item,out]}})}return item})}function showJoinSettingsModal(model){modelToSwitch=model,$scope.joinSettingsModal=$uibModal.open({templateUrl:'static/templates/include/join-settings.html;',scope:$scope,animation:!0,size:'lg'})}function addJoinSettings(settings,model,view){var bottomContainer=view.find('.bottom-container');bottomContainer.find('.join').remove(),_.each($scope.joinTypes,function(join){if(join.value==settings.type){var type=bottomContainer.find('#type')[0];type.textContent=join.name,$(type).on('click',function(e){e.stopPropagation(),configureNode({model:model,$box:view})})}}),_.each(settings.conditions,function(item,index){var add='<span class="join"><span class="add-wrap">';add+=0==index?'On ':'And ',add+='<a class="lnk">'+item.leftKey+' = '+item.rightKey+'</a></span></span>',bottomContainer.append(add)}),bottomContainer.find('.join').on('click',function(e){e.stopPropagation(),configureNode({model:model,$box:view})})}function dropNode(event,ui){var o=$(ui.draggable[0]),position={x:event.pageX-$(event.target).offset().left-37,y:event.pageY-$(event.target).offset().top-37};switch(o.attr('id')){case'join-button':return $scope.api.nodes.addJoin(position,!0);default:var uid=o.find('input.uid').val(),u=$scope.getUploadById(uid);return $scope.api.nodes.addSources([u],position,!0);}}function removeHighlight(){$scope.columnsListMenu.isOpen=!1,$scope.transformHistory=void 0,$scope.previewSettings=void 0,$scope.previewGridOptions={enableColumnResize:!0,columnDefs:[],data:[]},pointer.hide(),_.each(graph.getElements(),function(e){var view=paper.findViewByModel(e);view.$box.removeClass('hltd')})}function addHighlight(cellView){var bbox=cellView.model.getBBox(),color=cellView.$box.css('background-color');cellView.$box.addClass('hltd');var heightWithBottomContainer=cellView.$box.height()+cellView.$box.find('.bottom-container').height()+15;pointer.css('left',bbox.x+bbox.width/2+'px'),pointer.css('top',bbox.y+heightWithBottomContainer+'px'),pointer.show(),pointer.find('.head .inner').css('border-color','transparent transparent '+color+' transparent'),pointer.find('.body').css('background-color',color),previewWrapper.css('background-color',color)}function getJoinNodeInPorts(model,e){var links=graph.getConnectedLinks(model,{inbound:!0});2==links.length&&_.all(links,function(link){return'html.Link'==link.get('type')})&&(e.stopPropagation(),configureNode({model:model,$box:model.findView(paper).$box}))}function getFreePorts(cell,opts){var view=cell.findView(paper);if(!view)return[];var nonAvailablePorts=_(graph.getConnectedLinks(cell,opts)).map(function(link){var unlimitedInPort=!1;return('html.UnionNode'==cell.get('type')&&(unlimitedInPort=!0),opts.outbound&&!unlimitedInPort&&opts.inbound)?[link.get('source').port,link.get('target').port]:opts.outbound?link.get('source').port:!unlimitedInPort&&opts.inbound?link.get('target').port:void 0}).flatten().value();return _(cell.ports).filter(function(port){return(opts.inbound&&'in'===port.type||opts.outbound&&'out'==port.type)&&!_.contains(nonAvailablePorts,port.id)}).map(function(port,idx){var baseClass=port.type+'Ports';return{cell:cell,port:port,portView:view.$('.'+baseClass+'>.'+('port'+idx))[0]}}).value()}function tryCreateSampleLink(outPorts,inPorts){var connected=!1;_.each(outPorts,function(outPort){var bbox=joint.util.getElementBBox(outPort.portView),currentPortRect=joint.g.rect(bbox.x,bbox.y,bbox.width,bbox.height),currentPortCenter=currentPortRect.center();if(_.each(inPorts,function(inPort){bbox=joint.util.getElementBBox(inPort.portView);var availablePortRect=joint.g.rect(bbox.x,bbox.y,bbox.width,bbox.height),availablePortCenter=availablePortRect.center(),distance=currentPortCenter.distance(availablePortCenter);if(distance<linkSampleThreshold)return graph.addCell(new joint.shapes.html.LinkSample({source:{id:outPort.cell.id,port:outPort.port.id},target:{id:inPort.cell.id,port:inPort.port.id}})),connected=!0,!1}),connected)return!1})}function configureNode(cellView){if(!cellView.model.isLink()){var e=cellView.model;if('html.JoinNode'==e.get('type')){$scope.joinNode=e,$scope.joinNodeBox=cellView.$box,$scope.joinSettings=angular.copy(e.get('settings'));var leftL,rightL,links=graph.getConnectedLinks(e,{inbound:!0});links[0]&&links[0].get('target')&&('in1'==links[0].get('target').port?leftL=links[0]:rightL=links[0]),links[1]&&links[1].get('target')&&('in0'==links[1].get('target').port?leftL=links[1]:rightL=links[1]),leftL&&$http.post('/api/flow/columns',{flowJSON:serializeGraph(),rootNode:leftL.get('source').id}).success(function(data){$scope.joinLeftDs=data}).error(common.showError),rightL&&$http.post('/api/flow/columns',{flowJSON:serializeGraph(),rootNode:rightL.get('source').id}).success(function(data){$scope.joinRightDs=data}).error(common.showError),$scope.joinParam={type:'join'},$scope.joinType='JOIN',showJoinSettingsModal(e)}else'html.UnionNode'==e.get('type')&&($scope.joinParam={type:'union',text:'Fields will be added together based on fields name.'},$scope.joinType='UNION',showJoinSettingsModal(e))}}function fillOpsTransformList(node,transforms){var nodeOps=node.find('.ops-node');nodeOps.find('div.add').remove(),_.each(transforms,function(item,iter){var transform;5==iter?(transform='<div class="add"> + '+(transforms.length-5)+' more ops</div>',nodeOps.find('.ops-bottom-container').append(transform)):5>iter&&(transform='<div class="add">&bull; '+item.title.toUpperCase()+' for '+$scope.getTransformColumnNames(item)+'</div>',nodeOps.find('.ops-bottom-container').append(transform))}),nodeOps.find('.ops-node-text')[0].textContent=transforms.length+' Ops',nodeOps.is(':hidden')&&transforms.length?nodeOps.show():!transforms.length&&nodeOps.hide()}function getCurrentSettingsByName(originalName){return _.find($scope.selectedNode.model.get('settings').columns,function(column){return column.name==originalName})}function rowTransform(item){return{title:item.title,icon:'fa fa-fw',action:function action(){var columnName=this.context.col.colDef.originalName;$scope.addTransform(_.merge(item,{columnName:columnName}))}}}function addSeparator(){return{isSeparator:!0}}function renameColumn(){return{title:'Rename\u2026',icon:'fa fa-fw',action:function action(){var that=this;this.context.col.edited=this,this.context.col.rename=this.context.col.displayName,$timeout(function(){$('.data-preview').find('#'+that.context.col.grid.id+'-'+that.context.col.uid+'-new-name')[0].focus()})}}}function convertToListColumn(selected){return{title:'Convert to list...',icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.showConvertToListModal(settings)}}}function preserveHistoryColumn(selected){var m={title:'Preserve History\u2026',icon:function(selected){return selected?'fa fa-fw fa-check':'fa fa-fw'}(selected),action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.showPreserveHistoryModal(settings,m)}};return m}function annotateColumn(){return{title:'Annotate\u2026',icon:'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.showAnnotationModal(settings)}}}function distinctColumn(columns){return{title:'Deduplicate\u2026',icon:'fa fa-fw',action:function action(){$scope.showDistinctModal(columns,this.context.col.colDef.originalName)}}}function facets(isEnabled){return{title:'Disable facets',icon:isEnabled?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);settings.disableFacets=!settings.disableFacets,pushDisableFacets(settings),$scope.api.preview()}}}function setAsPk(isPk){return{title:'Set As Primary Key',icon:isPk?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var previousPkeyColumn,settings=getCurrentSettingsByName(this.context.col.colDef.originalName);if(!settings.pkey){var columns=$scope.selectedNode.model.get('settings').columns;_.each(columns,function(column){column.pkey&&(previousPkeyColumn=column),column.pkey=!1})}settings.pkey=!settings.pkey,$scope.api.preview(),pushSetAsPk(previousPkeyColumn,settings)}}}function formatCurrency(selected){return{title:'Currency\u2026',icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.showFormatModal(settings)}}}function coerceToFormat(title,format,selected){return{title:title,icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.setDataFormat(settings,format)}}}function deleteFormats(selected){return{title:'Automatic',icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.setDataFormat(settings)}}}function coerceToType(title,typeOrAction,selected){return{title:title,icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);settings.filter=null,settings.formatSymbol=null,settings.decimalPlaces=null;var oldTypeOrAction=angular.copy(settings.type),newTypeOrAction=angular.copy(typeOrAction);'function'==typeof typeOrAction?typeOrAction(settings):(settings.type=typeOrAction,settings.searchType='STRING'==settings.type.dataType?'EDGE':'NONE',$scope.api.preview(),pushCoerceToType(this.context.col.colDef.originalName,oldTypeOrAction,newTypeOrAction,settings))}}}function removeErrors(selected){return{title:'Remove Errors',icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);settings.removeErrors=!settings.removeErrors,$scope.api.preview(),pushRemoveErrors(settings.name)}}}function replaceErrors(selected){return{title:'Replace Errors\u2026',icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);$scope.showReplaceErrorsModal(settings)}}}function searchType(title,type,selected){return{title:title,icon:selected?'fa fa-fw fa-check':'fa fa-fw',action:function action(){var settings=getCurrentSettingsByName(this.context.col.colDef.originalName);settings.searchType=type,refreshPreviewFromCache()}}}function getVisibility(originalName){var settings=getCurrentSettingsByName(originalName);return!settings||!settings.removed}function getCellTemplate(field,settings){field=field.split('<').join('&lt;').split('>').join('&gt;').split('\\').join('\\\\');var params={field:field,before:null,after:null,filters:null};switch(settings.filter){case'financial':params.filters='| financialFilter';break;case'currency':params.before=settings.formatSymbol,params.filters='| number:'+(settings.decimalPlaces||0);break;case'number':params.filters='| number:'+settings.decimalPlaces;break;case'percent':params.after='%',params.filters='| number: 2';break;case'date':params.filters='| date: "MM/dd/yyyy"';break;case'time':params.filters='| date: "h:mma"';break;case'datetime':params.filters='| date: "MM/dd/yyyy HH:mm:ss"';break;case'codes':params.filters='| locationCodesFilter';break;case'lat-lon':params.filters='| locationLatLonFilter';break;case'duration':params.filters='| date: "HH:mm:ss"';}return''(params)}function preparePreviewData(response){if(response.descriptor&&$scope.selectedNode){var editable='html.OutputNode'!=$scope.selectedNode.model.get('type'),rowsCount=response.descriptor.rowsExactCount||response.descriptor.rowsEstimatedCount;$scope.previewSettings={skippedCount:response.skippedCount,name:actualSelectedNode.model.get('view').label||actualSelectedNode.$box.find('.icon-text').text(),enableNestedView:_.contains(['JSON_ARRAY','JSON_OBJECT','XML'],response.descriptor.format),columns:response.descriptor.columns.length,removedColumns:_.countBy($scope.selectedNode.model.get('settings').columns,'removed').true,rows:_Mathmin(rowsCount,1e3),editable:editable},$scope.currentQueryData.cachedPreviewData=response.cached,$scope.currentView&&($scope.currentView!=ViewType.NESTED||$scope.previewSettings.enableNestedView)||($scope.currentView=ViewType.TABLE),lastColumnDefs=[],lastPreviewResponse=response;var columnSettings=_.groupBy($scope.selectedNode.model.get('settings').columns,'name'),descriptorColumns=_.sortBy(response.descriptor.columns,'settings.index');_.each(descriptorColumns,function(column,index){var originalName=column.name,displayName=column.settings.rename||column.settings.name||column.name,menuItems=[],formatSubItems=[];switch(columnSettings[column.name]?(columnSettings[column.name]=column.settings,!column.settings.type&&(column.settings.type=column.type)):($scope.selectedNode.model.get('settings').columns.push(column.settings),column.settings.type=column.type,column.settings.name=originalName),column.settings.index=index,column.settings.searchType||('STRING'==column.settings.type.dataType?column.settings.searchType='EDGE':column.settings.searchType='NONE'),column.settings.type.dataType.toLowerCase()){case'location_lat_lon':column.settings.filter='lat-lon';break;case'location_usa_state_codes':case'location_country_codes':column.settings.filter='codes';}switch(column.settings.type.dataType.toLowerCase()){case'double':case'integer':formatSubItems.push(deleteFormats(!column.settings.filter)),formatSubItems.push(addSeparator()),formatSubItems.push(coerceToFormat('Number','number','number'==column.settings.filter)),formatSubItems.push(coerceToFormat('Percent','percent','percent'==column.settings.filter)),formatSubItems.push(addSeparator()),formatSubItems.push(formatCurrency('currency'==column.settings.filter)),formatSubItems.push(coerceToFormat('Financial','financial','financial'==column.settings.filter));break;case'date':formatSubItems.push(deleteFormats(!column.settings.filter)),formatSubItems.push(addSeparator()),formatSubItems.push(coerceToFormat('Date','date','date'==column.settings.filter)),formatSubItems.push(coerceToFormat('Time','time','time'==column.settings.filter)),formatSubItems.push(coerceToFormat('Date time','datetime','datetime'==column.settings.filter)),formatSubItems.push(coerceToFormat('Duration','duration','duration'==column.settings.filter));}menuItems.push({title:'Data Type',icon:'fa fa-fw',subItems:[coerceToType('String',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'STRING'},'STRING'==column.settings.type.dataType),coerceToType('Number (whole)',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'INTEGER'},'INTEGER'==column.settings.type.dataType),coerceToType('Number (decimal)',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'DOUBLE'},'DOUBLE'==column.settings.type.dataType),coerceToType('Date/Time\u2026',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'DATE'},'DATE'==column.settings.type.dataType),coerceToType('Boolean',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'BOOLEAN'},'BOOLEAN'==column.settings.type.dataType),{title:'Geographic',icon:'fa fa-fw '+(_.contains(['LOCATION_LAT_LON','LOCATION_USA_STATE_CODES','LOCATION_COUNTRY_CODES'],column.settings.type.dataType)?'fa-check':''),subItems:[coerceToType('Coordinates',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'LOCATION_LAT_LON'},'LOCATION_LAT_LON'==column.settings.type.dataType),coerceToType('Country Code',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'LOCATION_COUNTRY_CODES'},'LOCATION_COUNTRY_CODES'==column.settings.type.dataType),coerceToType('State Code',{"@class":'com.dataparse.server.service.parser.type.TypeDescriptor',dataType:'LOCATION_USA_STATE_CODES'},'LOCATION_USA_STATE_CODES'==column.settings.type.dataType)]}]}),formatSubItems.length&&menuItems.push({title:'Data Format',icon:'fa fa-fw',subItems:formatSubItems}),'html.OutputNode'==actualSelectedNode.model.get('type')&&(menuItems.push({title:'Search Type',icon:'fa fa-fw',subItems:[searchType('Do not search on column','NONE','NONE'==column.settings.searchType),searchType('Edge search','EDGE','EDGE'==column.settings.searchType),searchType('Full inner search','FULL','FULL'==column.settings.searchType)]}),menuItems.push(facets(column.settings.disableFacets))),menuItems.push(addSeparator()),'STRING'==column.settings.type.dataType&&(menuItems=menuItems.concat([rowTransform({title:'Uppercase',"@class":'.column.UpperTransform'}),rowTransform({title:'Lowercase',"@class":'.column.LowerTransform'}),rowTransform({title:'CamelCase',"@class":'.column.CapitalCaseTransform'}),rowTransform({title:'Clean whitespace',"@class":'.column.CleanWhitespaceTransform'})])),menuItems.push(distinctColumn(response.descriptor.columns)),menuItems=menuItems.concat([convertToListColumn(column.settings.splitOn),addSeparator(),renameColumn(),annotateColumn(),{title:'Handle Error',icon:'fa fa-fw',subItems:[removeErrors(column.settings.removeErrors),replaceErrors(column.settings.replaceErrors)]}]),(column.settings.pkey||column.pkey||_.contains(['STRING','INTEGER'],column.settings.type.dataType))&&(column.settings.preserveHistory=null,menuItems.push(setAsPk(column.settings.pkey))),column.settings.pkey||column.pkey||'html.OutputNode'!=actualSelectedNode.model.get('type')||menuItems.push(preserveHistoryColumn(!!column.settings.preserveHistory)),lastColumnDefs.push({name:'fields[\''+displayName+'\']',field:'fields[\''+displayName+'\']',visible:getVisibility(originalName),cellClass:'STRING'==column.settings.type.dataType?'left':'right',originalName:originalName,displayName:common.unscreen(displayName),annotation:column.settings.annotation,filter:column.settings.filter,formatSymbol:column.settings.formatSymbol,decimalPlaces:column.settings.decimalPlaces,width:'content',enableHiding:!1,enableColumnMenu:$scope.previewSettings.editable,enableColumnMoving:$scope.previewSettings.editable,menuItems:menuItems,cellTemplate:getCellTemplate(displayName,column.settings)})})}$scope.refreshCurrentView($scope.currentView)}function createTableView(response,columnDefs){var data=response.data,descriptor=response.descriptor;0==data.length&&($scope.previewGridOptions.data.length=0),$scope.previewGridOptions.columnDefs=[],descriptor&&$scope.selectedNode&&(data=_.map(data,function(row){return{fields:row}})),$timeout(function(){$scope.previewGridOptions={enableColumnResize:!0,columnDefs:columnDefs,data:data},$scope.gridApi.core.refresh(),$scope.gridApi.grid.refresh()})}function addListCustomFilter(column,data){switch(column.filter){case'financial':return $filter('financial')(data);case'currency':return column.formatSymbol+$filter('number')(data,column.decimalPlaces||0);case'number':return $filter('number')(data,column.decimalPlaces);case'percent':return $filter('number')(data,2)+'%';case'date':return $filter('date')(data,'MM/dd/yyyy');case'time':return $filter('date')(data,'h:mma');case'datetime':return $filter('date')(data,'MM/dd/yyyy HH:mm:ss');case'duration':return $filter('date')(data,'HH:mm:ss');default:return data;}}function refreshListView(){var start=($scope.listView.currentPagination-1)*$scope.listView.maxPerPage;fillListView(start,start+$scope.listView.maxPerPage)}function refreshNestedView(){var start=($scope.nestedView.currentPagination-1)*$scope.nestedView.maxPerPage;fillNestedView(start,start+$scope.nestedView.maxPerPage)}function fillListView(start,end){$scope.listView.data=[];var data=lastPreviewResponse.data.slice(start,end);_.each(data,function(data){var item=[];_.each(lastColumnDefs,function(colDef){var value=data[colDef.displayName]||data[colDef.originalName];colDef.visible&&value&&item.push({name:colDef.displayName,data:addListCustomFilter(colDef,value)})}),item.length&&$scope.listView.data.push(item)})}function fillNestedView(start,end){$scope.nestedView.data=_.map(lastPreviewResponse.data.slice(start,end),unflatten)}function makePagination(view){view.pagination=[];var start=1,end=_Mathmin(Math.ceil(view.totalSize/view.maxPerPage),500);view.pagination.push(start),view.currentPagination>start+3&&view.pagination.push('...');for(var i=start+1;i<end;++i)2>=Math.abs(i-view.currentPagination)&&view.pagination.push(i);view.currentPagination<end-3&&view.pagination.push('...'),end!=start&&view.pagination.push(end)}function unflatten(o){if(!o)return null;var result={};return _.each(o,function(v,k){var path=common.splitPath(k);addValueToPath(result,path,v)}),result}function addValueToPath(target,path,value){var newTarget,key=path[0];if(!!_.isArray(target)){var m2={};newTarget=m2,target.push(m2)}else if(_.has(target,key))newTarget=1<path.length?target[key]:target;else if(1<path.length){var m={};newTarget=m,target[key]=m}else newTarget=target;if(1<path.length)addValueToPath(newTarget,path.slice(1),value);else if(!_.isArray(newTarget)){var o=newTarget[key];if(void 0==o)newTarget[key]=value;else{var l=[];l.push(o),l.push(value),newTarget[key]=l}}else newTarget.push(value)}function getPreserveHistoryModalSettings(){return{retention:{value:1,period:['Hour','Day','Week'],selectedPeriod:'Hour'}}}function serializeGraph(){return angular.toJson(graph.toJSON())}function doPreview(){$scope.isPreviewRunning||($scope.isPreviewRunning=!0,$http.post('/api/flow/preview',$scope.lastPreviewParams).success(function(response){preparePreviewData(response),$scope.isPreviewRunning=!1,$scope.lastPreviewParams&&doPreview()}).error(function(){$scope.isPreviewRunning=!1,$scope.lastPreviewParams&&doPreview()}),$scope.lastPreviewParams=void 0)}function doValidate(){$scope.isValidationRunning||(0<graph.getElements().length?($scope.isValidationRunning=!0,$http.post('/api/flow/validate',$scope.lastValidateParams).success(function(data){$scope.errors=data,$scope.isValidationRunning=!1,$scope.lastValidateParams&&doValidate()}).error(function(e){$scope.isValidationRunning=!1,common.showError(e),$scope.lastValidateParams&&doValidate()}),$scope.lastValidateParams=void 0):$scope.errors=[])}function setUnloadRestriction(){window.onbeforeunload=!$scope.selectedTable.committed||$scope.isIndexChanged?function(){return'Data will be lost if you leave the page, are you sure?'}:void 0}var _Mathmin=Math.min;$scope.ViewType=ViewType,$scope.isModelLoading=!1;var graph,paper,outputNodeOffsetX=200;$scope.previewGridOptions={enableColumnResize:!0,columnDefs:[],data:[],onRegisterApi:function onRegisterApi(gridApi){$scope.gridApi=gridApi,gridApi.colMovable.on.columnPositionChanged($scope,$scope.endSortFieldsGrid),gridApi.colResizable.on.columnSizeChanged($scope,$scope.endResizeColumn)}};var refreshView=function(){$scope.currentView==ViewType.LIST?refreshListView():$scope.currentView==ViewType.NESTED?refreshNestedView():($scope.gridApi.core.refresh(),$scope.gridApi.grid.refresh())},sortFields=!1;$scope.endSortFields=function(oldPosition,newPosition){sortFields=!0,$scope.gridApi.colMovable.moveColumn(oldPosition,newPosition),refreshView()},$scope.endSortFieldsGrid=function(colDef,oldPos,newPos){sortFields||common.moveInArray($scope.previewGridOptions.columnDefs,oldPos,newPos),_.each($scope.previewGridOptions.columnDefs,function(columnDef,index){var settings=_.find($scope.selectedNode.model.get('settings').columns,function(col){return col.name==columnDef.originalName});settings&&(settings.index=index)}),sortFields=!1,fromHistory||pushEndSortFieldsGrid(oldPos,newPos),fromHistory=!1},$scope.endResizeColumn=function(colDef,deltaChange){fromHistory||pushEndResizeColumn(colDef.originalName,deltaChange),fromHistory=!1};var indexUploads={};$scope.errors=[],$scope.getWarningText=function(){return $scope.errors.length+' warning'+(1<$scope.errors.length?'s':'')},$scope.flowExecutionState={},$scope.isPreviewRunning=!1,$scope.isValidationRunning=!1,$scope.lastPreview=void 0,$scope.isCommitRunning=!1,$scope.isIndexChanged=!1,$scope.currentTask=void 0,$scope.highlightError=function(id,toggle){if(id){var model=graph.getCell(id);if(model){var view=model.findView(paper);toggle?view.$box.addClass('hltd-error'):view.$box.removeClass('hltd-error')}}},$scope.inputNodeOptions=function(){return[['Reveal Source',function(scope,e){$scope.showDsSearch(),$scope.search(e.targetNode.model.get('view').label)}],['Remove Source',function(scope,e){e.targetNode.model.remove()}]]},$scope.progressBar={remainingStr:'',value:0,step:0,steps:0,viewMode:function viewMode(){$scope.viewMode=!0}},$scope.showDsErrorModal=function(){$scope.dsErrorModal=$uibModal.open({templateUrl:'static/templates/include/ds-error.html',scope:$scope,animation:!0,size:'md'})},$scope.closeDsErrorModal=function(){$scope.dsErrorModal.dismiss()},$scope.api={load:function load(newTable){if(graph.clear(),HistoryService.clear(),$scope.errors=[],indexUploads={},previewRequestId=common.randomGUID(),_.each(newTable.uploads,function(u){indexUploads[u.id]=u}),null==newTable.flowJSON)return!0;$scope.isModelLoading=!0;var graphModel=JSON.parse(newTable.flowJSON);return $timeout(function(){graph.fromJSON(graphModel);var cells=graph.getCells();_.each(cells,function(cell){var model=graph.getCell(cell.attributes.id),settings=cell.attributes.settings,view=model.findView(paper).$box;if(!_.contains(['html.Link','html.OutputNode'],cell.attributes.type)){if('html.InputNode'==cell.get('type')){var u=indexUploads[cell.get('settings').uploadId];u&&(cell.get('view').label=u.name,cell.findView(paper).updateBox())}fillOpsTransformList(view,model.get('settings').transforms)}'html.JoinNode'==cell.attributes.type&&addJoinSettings(settings,model,view)}),$scope.api.validate(),$scope.isModelLoading=!1}),$http.post('/api/flow/get_active_task',{tableId:newTable.id}).success(function(task){task&&($scope.isCommitRunning=!0,startFlowStatePolling(task.id))}).error(common.showError),!0},onChange:function onChange(){$scope.selectedTable&&$scope.selectedTable.committed&&($scope.isIndexChanged=!0),$scope.progressBar.isFinished=!1,setUnloadRestriction(),$scope.api.validate()},validate:function validate(){$scope.lastValidateParams={flowJSON:serializeGraph()},doValidate()},preview:function preview(){$scope.lastPreviewParams={requestId:previewRequestId,flowJSON:serializeGraph(),rootNode:$scope.selectedNode.model.id},doPreview()},cancel:function cancel(){$http.post('/api/flow/cancel',{taskId:$scope.currentTask}).success(function(){$scope.isCommitCancelling=!0})},configureRefresh:function configureRefresh(){$scope.updateTable().then(function(){$uibModal.open({controller:'refreshSettingsCtrl',templateUrl:'static/templates/include/refresh-settings.html',resolve:{indexId:function indexId(){return $scope.selectedTable.id},refreshSettings:function refreshSettings(){return angular.copy($scope.selectedTable.refreshSettings)},onSuccess:function onSuccess(){return function(result){$scope.selectedTable.refreshSettings=result}}}})})},commit:function commit(){return $scope.selectedTable&&$scope.selectedTable.id?void($scope.isCommitRunning=!0,$scope.updateTable().then(function(){$http.post('/api/flow/execute',{tableId:$scope.selectedTable.id}).success(function(taskId){startFlowStatePolling(taskId),$scope.isIndexChanged=!1,setUnloadRestriction()}).error(function(e){common.showError(e),$scope.isCommitRunning=!1,$scope.isCancelRunning=!1})})):void common.showError({message:'Please select index or create new one'})},clear:function clear(){graph.clear()},resize:function resize(height){height||(height=$localStorage.workspaceH),(!height||400>height)&&(height=400),paper&&paper.setDimensions($elm.find('#worksheet').width(),height)},nodes:{addSources:function addSources(us,position,suppressHistory){$scope.selectedTable||$scope.createIndex();var items=[];return _.forEach(us,function(u){if('composite-ds'==u.type)_.forEach(u.sections,function(s){var item=createInputSource(s,position);items.push(item)});else if('ds'==u.type||'section-ds'===u.type||'folder'==u.type){var item=createInputSource(u,position);items.push(item)}}),$q.all(_.map(items,function(item){return addToGraph(item)})).then(function(items){var tmp=[];return _.each(items,function(i){_.isArray(i)?tmp=tmp.concat(i):tmp.push(i)}),suppressHistory||(pushAddNodeEvent(tmp),$scope.api.onChange()),tmp})},addJoin:function addJoin(position,suppressHistory){var item=createItem(joint.shapes.html.JoinNode,{},{"@class":'.JoinNodeSettings',conditions:[{leftKey:void 0,fn:'EQ',rightKey:void 0}],transforms:[],columns:[]},{position:position,inPorts:['in1','in2'],outPorts:['out']});return addToGraph(item).then(function(item){return suppressHistory||($scope.api.onChange(),pushAddNodeEvent(item)),item})},addUnion:function addUnion(position,suppressHistory){var item=createItem(joint.shapes.html.UnionNode,{},{"@class":'.UnionNodeSettings',transforms:[],columns:[]},{position:position,inPorts:['in1'],outPorts:['out']});return addToGraph(item).then(function(item){return suppressHistory||($scope.api.onChange(),pushAddNodeEvent(item)),item})},addOutput:function addOutput(position,tableId){var item=createItem(joint.shapes.html.OutputNode,{},{"@class":'.OutputNodeSettings',tableId:tableId,transforms:[],columns:[]},{inPorts:['in1'],position:position});return addToGraph(item)}},history:{hasPrev:function hasPrev(){return HistoryService.canUndo()},hasNext:function hasNext(){return HistoryService.canRedo()},undo:function undo(){return HistoryService.undo()},redo:function redo(){return HistoryService.redo()}}};var modelToSwitch,delta=0;$scope.cancelJoinSettings=function(){$scope.joinSettingsModal.dismiss()},$scope.switchJoin=function(){$scope.switchNodeType(modelToSwitch),$scope.joinSettingsModal.dismiss()},$scope.joinTypeSelected=function(){switch($scope.joinType){case'JOIN':$scope.joinParam={type:'join'};break;case'UNION':$scope.joinParam={type:'union',text:'Fields will be added together based on fields name.'};}},$scope.availableJoinTypes=['JOIN','UNION'],$scope.joinType=void 0,$scope.joinTypes=[{name:'INNER JOIN',value:'INNER'},{name:'LEFT OUTER JOIN',value:'LEFT_OUTER'},{name:'RIGHT OUTER JOIN',value:'RIGHT_OUTER'},{name:'FULL OUTER JOIN',value:'FULL_OUTER'}],$scope.joinLeftDs=[],$scope.joinRightDs=[],$scope.joinSettings=void 0,$scope.joinNode=void 0,$scope.joinNodeBox=void 0,$scope.addJoinCondition=function(){$scope.joinSettings.conditions.push({leftKey:void 0,fn:'EQ',rightKey:void 0})},$scope.removeJoinCondition=function(idx){$scope.joinSettings.conditions.splice(idx,1)},$scope.getTransformColumnNames=function(transform){return transform.columnName?common.unscreen(transform.columnName):_.map(transform.columnNames,common.unscreen).join(', ')},$scope.saveJoinSettings=function(){modelToSwitch!=$scope.joinNode&&$scope.switchNodeType(modelToSwitch);var lastSettings=angular.copy($scope.joinNode.get('settings')),currentSettings=angular.copy($scope.joinSettings),node=$scope.joinNode;$scope.joinNode.set('settings',$scope.joinSettings),$scope.api.onChange(),pushEditJoinSettingsEvent(node,lastSettings,currentSettings),addJoinSettings(currentSettings,$scope.joinNode,$scope.joinNodeBox),$scope.joinSettingsModal.dismiss()};var items,lastIcon,pointer=$elm.find('.arrow'),previewWrapper=$elm.find('.data-preview-wrapper');$elm.find('.toolbar-icon').draggable({helper:'clone',cancel:!1}),$elm.find('#worksheet').droppable({accept:'.upload-item,.toolbar-icon',hoverClass:'drop-active',over:function over(event,ui){lastIcon=ui.helper.html(),ui.helper.empty(),dropNode(event,ui).then(function(result){items=_.isArray(result)?result:[result],_.each(items,function(item){var type=item.get('type');'html.Link'!=type&&'html.LinkSample'!=type&&item.findView(paper).$el.find('rect').mousedown()})})},out:function out(event,ui){items&&lastIcon&&(ui.helper.html(lastIcon),_.each(items,function(item){item.remove()}),items=void 0)},drop:function drop(){pushAddNodeEvent(items),items=void 0,$scope.api.onChange()}}),joint.shapes.html={},joint.shapes.html.Element=joint.shapes.basic.Generic.extend(_.extend({},joint.shapes.basic.PortsModelInterface,{markup:'<g class="rotatable"><g class="scalable"><rect/></g><g class="inPorts"/><g class="outPorts"/></g>',inPortMarkup:'<g class="port<%= id %>"><circle/></g>',outPortMarkup:'<g class="port<%= id %>"><circle/></g>',defaults:joint.util.deepSupplement({type:'html.Element',size:{width:100,height:80},inPorts:[],outPorts:[],attrs:{".":{magnet:!1},rect:{stroke:'none',"fill-opacity":0,width:150,height:250},circle:{r:8,magnet:!0,fill:'transparent',stroke:'transparent'},".inPorts circle":{magnet:'passive',type:'input'},".outPorts circle":{type:'output'}}},joint.shapes.basic.Generic.prototype.defaults),getPortAttrs:function getPortAttrs(portName,index,total,selector,type){var attrs={},portSelector=selector+'>.'+('port'+index);return attrs[portSelector+'>circle']={port:{id:portName||_.uniqueId(type),type:type}},attrs[portSelector]={ref:'rect',"ref-y":(index+.5)*(1/total)},'.outPorts'===selector&&(attrs[portSelector]['ref-dx']=0),attrs}})),joint.shapes.html.Link=joint.dia.Link.extend({defaults:{type:'html.Link',attrs:{".connection":{"stroke-width":1,stroke:'#BBB'}},router:{name:'manhattan',args:{startDirections:['left','right'],endDirections:['left','right']}},connector:{name:'rounded',args:{radius:10}}},markup:['<path class="connection"/>','<path class="connection-wrap"/>','<g class="labels"/>','<g class="link-tools" opacity="0"/>'].join(''),toolMarkup:['<g class="link-tool">','<g class="tool-remove" event="remove">','<circle id="outer" r="11" fill="white"/>','<circle id="inner" r="9" fill="white"/>','<line id="line" x1="-5" x2="5" y1="0" y2="0" stroke="white" stroke-width="2" stroke-linecap="round"/>','<title>Remove link.</title>','</g>','</g>'].join('')}),joint.shapes.html.LinkSample=joint.dia.Link.extend({defaults:{type:'html.LinkSample',attrs:{".connection":{"stroke-width":1,stroke:'#CCC',"stroke-dasharray":'3, 2'}},router:{name:'manhattan',args:{startDirections:['left','right'],endDirections:['left','right']}},connector:{name:'rounded',args:{radius:10}}}}),joint.shapes.html.InputNode=joint.shapes.html.Element.extend({defaults:joint.util.deepSupplement({type:'html.InputNode'},joint.shapes.html.Element.prototype.defaults)}),joint.shapes.html.UnionFolderNode=joint.shapes.html.Element.extend({defaults:joint.util.deepSupplement({type:'html.UnionFolderNode'},joint.shapes.html.Element.prototype.defaults)}),joint.shapes.html.OutputNode=joint.shapes.html.Element.extend({defaults:joint.util.deepSupplement({type:'html.OutputNode'},joint.shapes.html.Element.prototype.defaults)}),joint.shapes.html.JoinNode=joint.shapes.html.Element.extend({defaults:joint.util.deepSupplement({type:'html.JoinNode'},joint.shapes.html.Element.prototype.defaults)}),joint.shapes.html.UnionNode=joint.shapes.html.Element.extend({defaults:joint.util.deepSupplement({type:'html.UnionNode'},joint.shapes.html.Element.prototype.defaults)}),$scope.switchNodeType=function(model){var position=model.attributes.position,type=model.attributes.type;model.remove();var factoryFn;'html.JoinNode'==type?factoryFn=$scope.api.nodes.addUnion:'html.UnionNode'==type&&(factoryFn=$scope.api.nodes.addJoin),factoryFn&&factoryFn(position,!0).then(function(item){$scope.api.onChange(),HistoryService.push({redo:function redo(){model.remove(),addToGraph(item),$scope.api.onChange()},undo:function undo(){item.remove(),addToGraph(model),$scope.api.onChange()}})})},joint.shapes.html.LinkView=joint.dia.LinkView.extend({updateToolsPosition:function updateToolsPosition(){if(!this._V.labels)return this;var scale='',offset=this.getConnectionLength()/2,connectionLength=this.getConnectionLength();if(!_.isNaN(connectionLength)){connectionLength<this.options.shortLinkLength&&(scale='scale(.5)');var toolPosition=this.getPointAtLength(offset);if(this._toolCache.attr('transform','translate('+toolPosition.x+', '+toolPosition.y+') '+scale),this.options.doubleLinkTools&&connectionLength>=this.options.longLinkLength){var doubleLinkToolsOffset=this.options.doubleLinkToolsOffset||offset;toolPosition=this.getPointAtLength(connectionLength-doubleLinkToolsOffset),this._tool2Cache.attr('transform','translate('+toolPosition.x+', '+toolPosition.y+') '+scale),this._tool2Cache.attr('visibility','visible')}else this.options.doubleLinkTools&&this._tool2Cache.attr('visibility','hidden')}return this}}),joint.shapes.html.LinkSampleView=joint.dia.LinkView.extend({}),joint.shapes.html.ElementView=joint.dia.ElementView.extend({initialize:function initialize(){_.bindAll(this,'updateBox'),joint.dia.ElementView.prototype.initialize.apply(this,arguments),this.$box=$(_.template(arguments[1])()),this.$box.append('<div class="progress-container">'+'<div class="percent"></div>'+'<div class="progress" style="margin-bottom: 0;">'+'<div class="progress-bar" role="progressbar" style="width: 0"></div>'+'</div>'+'</div>');var model=this.model;if('html.OutputNode'!=model.get('type')){var template=$templateCache.get(common.getFullTemplateName('worksheet/ops-node'));this.$box.append(template)}this.$box.find('.switch').on('click',function(){$scope.switchNodeType(model)}),this.$box.find('.delete').on('click',_.bind(function(){$scope.selectedNode&&model.cid==$scope.selectedNode.model.cid&&removeHighlight(),model.remove.call(model),pushDeleteNodeEvent(model)})),this.model.on('change',this.updateBox,this),this.model.on('remove',this.removeBox,this),this.updateBox();var settings=this.model.get('settings');if(settings.uploadId){var u=indexUploads[settings.uploadId];if(u.descriptor&&_.contains(['CSV','XLS_SHEET','XLSX_SHEET'],u.descriptor.format)){var startOnRowLabel=this.$box.find('.start-on-row'),refreshStartOnRowLabel=function(row){startOnRowLabel.find('.lnk').text('Row '+row)};if(0<startOnRowLabel.length){var rowSpan=this.$box.find('.row-text');startOnRowLabel.show(),rowSpan.show(),refreshStartOnRowLabel(u.descriptor.settings.startOnRow),startOnRowLabel.find('.lnk').on('click',function(){$scope.$apply(function(){'CSV'==u.descriptor.format?$scope.editCsvSettings(u,function(upload){u.descriptor=upload.descriptor,refreshStartOnRowLabel(upload.descriptor.settings.startOnRow)}):$scope.editXlsSettings(u,function(upload){u.descriptor=upload.descriptor,refreshStartOnRowLabel(upload.descriptor.settings.startOnRow)})})})}var useHeadersLabel=this.$box.find('.use-headers'),refreshUseHeadersLabel=function(useHeaders){useHeaders?useHeadersLabel.find('.lnk').text('Use Headers'):useHeadersLabel.find('.lnk').text('Skip Headers')};0<useHeadersLabel.length&&(useHeadersLabel.show(),refreshUseHeadersLabel(u.descriptor.settings.useHeaders),useHeadersLabel.find('.lnk').on('click',function(){$scope.$apply(function(){'CSV'==u.descriptor.format?$scope.editCsvSettings(u,function(upload){u.descriptor=upload.descriptor,refreshUseHeadersLabel(upload.descriptor.settings.useHeaders)}):$scope.editXlsSettings(u,function(upload){u.descriptor=upload.descriptor,refreshUseHeadersLabel(upload.descriptor.settings.useHeaders)})})}))}}},render:function render(){return joint.dia.ElementView.prototype.render.apply(this,arguments),this.paper.$el.prepend(this.$box),this.updateBox(),this},update:function update(){this.renderPorts(),joint.dia.ElementView.prototype.update.apply(this,arguments)},updateBox:function updateBox(){var bbox=this.model.getBBox();this.$box.find('.lbl').text(this.model.get('view').label),this.$box.css({width:bbox.width,height:bbox.height,left:bbox.x,top:bbox.y,transform:'rotate('+(this.model.get('angle')||0)+'deg)',"z-index":100+this.model.get('z')})},removeBox:function removeBox(){this.$box.remove()},renderPorts:function renderPorts(){var $inPorts=this.$('.inPorts').empty(),$outPorts=this.$('.outPorts').empty(),outPortTemplate=_.template(this.model.outPortMarkup),inPortTemplate=_.template(this.model.inPortMarkup);_.each(_.filter(this.model.ports,function(p){return'in'===p.type}),function(port,index){$inPorts.append(joint.V(inPortTemplate({id:index,port:port})).node)}),_.each(_.filter(this.model.ports,function(p){return'out'===p.type}),function(port,index){$outPorts.append(joint.V(outPortTemplate({id:index,port:port})).node)})}}),joint.shapes.html.InputNodeView=joint.shapes.html.ElementView.extend({initialize:function initialize(){var template=$templateCache.get(common.getFullTemplateName('worksheet/input-node')),args=Array.prototype.slice.call(arguments);joint.shapes.html.ElementView.prototype.initialize.apply(this,args.concat([template]))}}),joint.shapes.html.UnionFolderNodeView=joint.shapes.html.ElementView.extend({initialize:function initialize(){var template=$templateCache.get(common.getFullTemplateName('worksheet/union-folder-node')),args=Array.prototype.slice.call(arguments);joint.shapes.html.ElementView.prototype.initialize.apply(this,args.concat([template]))}}),joint.shapes.html.OutputNodeView=joint.shapes.html.ElementView.extend({initialize:function initialize(){var template=$templateCache.get(common.getFullTemplateName('worksheet/output-node')),args=Array.prototype.slice.call(arguments);joint.shapes.html.ElementView.prototype.initialize.apply(this,args.concat([template]))}}),joint.shapes.html.JoinNodeView=joint.shapes.html.ElementView.extend({initialize:function initialize(){var template=$templateCache.get(common.getFullTemplateName('worksheet/join-node')),args=Array.prototype.slice.call(arguments);joint.shapes.html.ElementView.prototype.initialize.apply(this,args.concat([template]));var that=this;this.$box.find('.bottom-container').on('click',function(e){e.stopPropagation(),configureNode({model:that.model,$box:that.$box})})}}),joint.shapes.html.UnionNodeView=joint.shapes.html.ElementView.extend({initialize:function initialize(){var template=$templateCache.get(common.getFullTemplateName('worksheet/union-node')),args=Array.prototype.slice.call(arguments);joint.shapes.html.ElementView.prototype.initialize.apply(this,args.concat([template]))}}),joint.dia.Worksheet=joint.dia.Paper.extend({pointermove:function pointermove(evt){evt.preventDefault(),evt=joint.util.normalizeEvent(evt);var localPoint=this.snapToGrid({x:evt.clientX,y:evt.clientY});this.sourceView&&(this._mousemoved++,this.sourceView.pointermove(evt,localPoint.x,localPoint.y)),this.trigger('pointermove',evt,localPoint.x,localPoint.y)}}),graph=new joint.dia.Graph,paper=new joint.dia.Worksheet({el:$elm.find('#worksheet'),gridSize:10,model:graph,linkPinning:!1,snapLinks:{radius:30},interactive:function interactive(cellView){return!(cellView.model instanceof joint.dia.Link)||{vertexAdd:!1}},defaultLink:new joint.shapes.html.Link,validateConnection:function validateConnection(cellViewS,magnetS,cellViewT,magnetT,end,linkView){var links=graph.getLinks();if(!_.contains(cellViewT.el.classList,'UnionNode'))for(var i=0;i<links.length;i++)if(linkView!=links[i].findView(paper)&&(cellViewT.model.id==links[i].get('source').id&&magnetT.getAttribute('port')==links[i].get('source').port||cellViewT.model.id==links[i].get('target').id&&magnetT.getAttribute('port')==links[i].get('target').port))return!1;return!(magnetS&&'input'===magnetS.getAttribute('type'))&&cellViewS!==cellViewT&&magnetT&&'input'===magnetT.getAttribute('type')},validateMagnet:function validateMagnet(cellView,magnet){for(var links=graph.getLinks(),i=0;i<links.length;i++)if(cellView.model.id==links[i].get('source').id&&magnet.getAttribute('port')==links[i].get('source').port||cellView.model.id==links[i].get('target').id&&magnet.getAttribute('port')==links[i].get('target').port)return!1;return'passive'!==magnet.getAttribute('magnet')}}),$scope.api.resize(),paper.on('blank:contextmenu',function(evt){evt.preventDefault()}),paper.on('cell:contextmenu',function(cellView,evt){evt.preventDefault(),cellView.model.isLink()||'html.InputNode'!=cellView.model.get('type')||$scope.$apply(function(){var options=$scope.inputNodeOptions();event.targetNode=cellView,common.renderContextMenu($scope,event,options)})}),paper.on('cell:pointerclick',function(cellView){if(!cellView.model.isLink()){var sourceView;if('html.OutputNode'==cellView.model.get('type')){var link=graph.getConnectedLinks(cellView.model,{inbound:!0})[0];link&&(sourceView=paper.findViewByModel(graph.getCell(link.get('source').id)))}var oldNode=$scope.selectedNode;$scope.selectedNode=sourceView||cellView;var updatePreview=null==actualSelectedNode||cellView.model.id!=actualSelectedNode.model.id;actualSelectedNode=cellView,cellView.model.toFront(),updatePreview&&(removeHighlight(),addHighlight(cellView),'html.OutputNode'!=$scope.selectedNode.model.get('type')&&($scope.transformHistory=$scope.selectedNode.model.get('settings').transforms,fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory)),$scope.api.preview(),pushSelectNode(oldNode,$scope.selectedNode))}});var lastPosition;paper.on('cell:pointerdown',function(cellView,evt){if(!cellView.model.isLink())lastPosition=cellView.model.position();else{var targetParentEvent=evt.target.parentNode.getAttribute('event');targetParentEvent&&'remove'===targetParentEvent&&pushDeleteLinkEvent(cellView.model)}}),paper.on('cell:pointerup',function(cellView,evt){if(!cellView.model.isLink()){var lastCellPosition=lastPosition,currentCellPosition=cellView.model.position();lastCellPosition.x==currentCellPosition.x&&lastCellPosition.y==currentCellPosition.y||items||pushMoveNodeEvent(cellView,lastCellPosition,currentCellPosition),_.each(graph.getLinks(),function(link){if('html.LinkSample'==link.get('type')){link.remove();var newLink=new joint.shapes.html.Link({source:link.get('source'),target:link.get('target')});graph.addCell(newLink);var model=graph.getCell(newLink.get('target').id);'html.JoinNode'==model.get('type')&&getJoinNodeInPorts(model,evt),$scope.api.onChange()}})}else cellView.targetView&&'html.JoinNode'==cellView.targetView.model.get('type')&&getJoinNodeInPorts(cellView.targetView.model,evt)}),paper.on('cell:mouseover',function(cellView){cellView.model.isLink()||cellView.$box.find('a.delete').css('color','#CBCBCB').hover(function(){$(this).css('color','#CBCBCB').css('text-decoration','underline')},function(){$(this).css('color','#CBCBCB').css('text-decoration','none')})}),paper.on('cell:mouseout',function(cellView){cellView.model.isLink()||cellView.$box.find('a.delete').css('color','transparent')}),paper.off('cell:highlight'),paper.off('cell:unhighlight'),paper.on('cell:highlight',function(cellView,evt){var portNumber=$(evt).attr('port');'in1'==portNumber?cellView.$box.find('.in-port-1').length?cellView.$box.find('.in-port-1').addClass('highlight'):cellView.$box.find('.in-port').addClass('highlight'):'in2'==portNumber&&cellView.$box.find('.in-port-2').addClass('highlight')}),paper.on('cell:unhighlight',function(cellView){cellView.$box.find('.highlight').removeClass('highlight')});var linkSampleThreshold=140;paper.on('pointermove',function(evt,x,y){items&&_.each(items,function(item){var type=item.get('type');'html.Link'!=type&&'html.LinkSample'!=type&&('html.OutputNode'==type?item.position(x-40+outputNodeOffsetX,y-40):item.position(x-40,y-40))})}),paper.on('cell:pointermove',function(cellView){var links=graph.getConnectedLinks(cellView.model);_.forEach(links,function(link){if('html.LinkSample'==link.get('type')){var distance=paper.findViewByModel(link).getConnectionLength();distance>linkSampleThreshold+10&&link.remove()}}),actualSelectedNode&&actualSelectedNode.model.id==cellView.model.id&&addHighlight(cellView);var currentOutPorts=getFreePorts(cellView.model,{outbound:!0}),availableInPorts=_(graph.getElements()).filter(function(cell){return cell.id!=cellView.model.id}).map(function(cell){return getFreePorts(cell,{inbound:!0})}).flatten().value();tryCreateSampleLink(currentOutPorts,availableInPorts);var currentInPorts=getFreePorts(cellView.model,{inbound:!0}),availableOutPorts=_(graph.getElements()).filter(function(cell){return cell.id!=cellView.model.id}).map(function(cell){return getFreePorts(cell,{outbound:!0})}).flatten().value();tryCreateSampleLink(availableOutPorts,currentInPorts)}),graph.on('change:source change:target',function(link){'html.LinkSample'!=link.get('type')&&link.get('source').id&&link.get('target').id&&$scope.api.onChange()}),graph.on('remove',function(cell){if(!cell.isLink()){$scope.selectedNode&&cell.id==$scope.selectedNode.model.id&&($scope.selectedNode=void 0,actualSelectedNode=void 0);var elements=graph.getElements();if(1==elements.length&&'html.OutputNode'==elements[0].get('type')){var out=elements[0];$scope.selectedNode&&removeHighlight(),out.remove()}}$scope.api.onChange()}),$scope.transformHistory=[],$scope.addTransform=function(item){$scope.isIndexChanged||($scope.isIndexChanged=!0),$scope.transformHistory.push(item),fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory),$scope.api.preview();var index=$scope.transformHistory.length-1;pushAddTransform(item,index)},$scope.deleteTransform=function(i){var itemCopy=angular.copy($scope.transformHistory[i]);$scope.isIndexChanged||($scope.isIndexChanged=!0),$scope.transformHistory.splice(i,1),fillOpsTransformList($scope.selectedNode.$box,$scope.transformHistory),$scope.api.preview(),pushDeleteTransform(itemCopy,i)},$scope.updateColumnName=function(column){column.edited=!1;var columnSettings=_.find($scope.selectedNode.model.get('settings').columns,{name:column.colDef.originalName}),oldColName=column.displayName;columnSettings.rename=column.rename,column.displayName=column.rename,$scope.api.preview(),pushUpdateColumnName(oldColName,column.displayName)},$scope.getCurrentSettingsByName=getCurrentSettingsByName,$scope.keydownColumnName=function(column,event){27==event.which?(column.rename=column.displayName,event.target.blur(),event.preventDefault(),event.stopPropagation()):13==event.which&&(column.edited=!1,event.target.blur(),event.preventDefault(),event.stopPropagation())},$scope.getValueType=function(value){if(null==value||value==void 0)return'null';return value.type&&'ERROR'==value.type?'error':'default'},$scope.isArray=function(value){return _.isArray(value)},$scope.wrapArray=function(value){return _.isArray(value)?value:[value]};var lastPreviewResponse,lastColumnDefs=[];$scope.selectAllNone=!0,$scope.selectAllNoneFields=function(){$scope.selectAllNone=!$scope.selectAllNone,_.each($scope.previewGridOptions.columnDefs,function(columnDef){columnDef.visible=$scope.selectAllNone;var settings=getCurrentSettingsByName(columnDef.originalName);settings.removed=!columnDef.visible}),$scope.previewSettings.removedColumns=_.countBy($scope.selectedNode.model.get('settings').columns,'removed').true,$scope.previewSettings.columns=lastPreviewResponse.descriptor.columns.length-($scope.previewSettings.removedColumns||0),refreshView()},$scope.switchVisibility=function(columnDef){columnDef.visible=!columnDef.visible;var settings=getCurrentSettingsByName(columnDef.originalName);settings.removed=!columnDef.visible,$scope.previewSettings.removedColumns=_.countBy($scope.selectedNode.model.get('settings').columns,'removed').true,$scope.previewSettings.columns=lastPreviewResponse.descriptor.columns.length-($scope.previewSettings.removedColumns||0),refreshView()},$scope.columnsListMenu={isOpen:!1,appendTo:angular.element(document.querySelector('.data-preview-title')),toggleMenu:function toggleMenu(){$scope.columnsListMenu.isOpen=!$scope.columnsListMenu.isOpen}},$scope.switchPaginate=function(view,pag){view.currentPagination=pag,makePagination(view);var start=(view.currentPagination-1)*view.maxPerPage;$scope.currentView==ViewType.LIST?fillListView(start,start+view.maxPerPage):$scope.currentView==ViewType.NESTED&&fillNestedView(start,start+view.maxPerPage)},$scope.nestedView={data:[],pagination:[],currentPagination:1,maxPerPage:10},$scope.listView={data:[],pagination:[],currentPagination:1,maxPerPage:10},$scope.refreshCurrentView=function(viewType){viewType!=void 0&&($scope.currentView=viewType),$scope.currentView==ViewType.LIST?($scope.listView.totalSize=lastPreviewResponse.data.length,$scope.listView.currentPagination=1,makePagination($scope.listView),fillListView(0,$scope.listView.maxPerPage)):$scope.currentView==ViewType.NESTED?($scope.nestedView.totalSize=lastPreviewResponse.data.length,$scope.nestedView.currentPagination=1,makePagination($scope.nestedView),fillNestedView(0,$scope.nestedView.maxPerPage)):$scope.currentView==ViewType.TABLE&&createTableView(lastPreviewResponse,lastColumnDefs)},$scope.dateFormatModalSettings={column:null,pattern:null},$scope.showDateFormatModal=function(settings,originalType){var pattern=settings.type.pattern||originalType&&originalType.pattern;$scope.dateFormatModalSettings={column:settings,pattern:pattern},$scope.dateFormatModal=$uibModal.open({templateUrl:'static/templates/include/date-format.html',scope:$scope,animation:!0,size:'sm'})},$scope.closeDateFormatModal=function(){$scope.dateFormatModal.dismiss()},$scope.updateDateFormat=function(){var oldType=angular.copy($scope.dateFormatModalSettings.column.type);$scope.dateFormatModalSettings.column.type={"@class":'com.dataparse.server.service.parser.type.DateTypeDescriptor',dataType:'DATE',pattern:$scope.dateFormatModalSettings.pattern},$scope.dateFormatModal.dismiss(),$scope.api.preview();var newType=angular.copy($scope.dateFormatModalSettings.column.type);pushCoerceToType($scope.dateFormatModalSettings.column.name,oldType,newType)},$scope.replaceErrorsModalSettings={column:null,typeNameText:null,replaceErrors:null},$scope.showReplaceErrorsModal=function(settings){$scope.replaceErrorsModalSettings.column=settings,$scope.replaceErrorsModalSettings.typeNameText=common.typeNameMappings[settings.type.dataType],$scope.replaceErrorsModalSettings.replaceErrors=settings.replaceErrors,$scope.replaceErrorsModal=$uibModal.open({templateUrl:'static/templates/include/replace-errors.html',scope:$scope,animation:!0,size:'md'})},$scope.closeReplaceErrorsModal=function(){$scope.replaceErrorsModal.dismiss()},$scope.updateReplaceErrors=function(){var oldReplace=$scope.replaceErrorsModalSettings.column.replaceErrors;$scope.replaceErrorsModalSettings.column.replaceErrors=$scope.replaceErrorsModalSettings.replaceErrors,$scope.api.preview(),$scope.replaceErrorsModal.dismiss(),pushUpdateReplaceErrors($scope.replaceErrorsModalSettings.column.name,oldReplace,$scope.replaceErrorsModalSettings.column.replaceErrors)},$scope.deleteReplaceErrors=function(){var oldReplace=$scope.replaceErrorsModalSettings.column.replaceErrors;$scope.replaceErrorsModalSettings.column.replaceErrors=null,$scope.replaceErrorsModalSettings.replaceErrors=null,$scope.api.preview(),$scope.replaceErrorsModal.dismiss(),pushDeleteReplaceErrors($scope.replaceErrorsModalSettings.column.name,oldReplace,$scope.replaceErrorsModalSettings.column.replaceErrors)},$scope.annotationModalSettings={column:null,annotation:null,oldAnnotation:null},$scope.showAnnotationModal=function(settings){$scope.annotationModalSettings.column=settings,$scope.annotationModalSettings.column.annotation?($scope.annotationModalSettings.oldAnnotation=$scope.annotationModalSettings.column.annotation,$scope.annotationModalSettings.annotation=$scope.annotationModalSettings.column.annotation):$scope.annotationModalSettings.annotation=void 0,$scope.annotationModal=$uibModal.open({templateUrl:'static/templates/include/preview-annotation.html',scope:$scope,animation:!0,size:'md'})},$scope.convertToListModalSettings={column:null,separator:null,oldSeparator:null},$scope.showConvertToListModal=function(settings){$scope.convertToListModalSettings.column=settings,$scope.convertToListModalSettings.column.splitOn?($scope.convertToListModalSettings.oldSeparator=$scope.convertToListModalSettings.column.splitOn,$scope.convertToListModalSettings.separator=$scope.convertToListModalSettings.column.splitOn):$scope.convertToListModalSettings.separator=',',$scope.convertToListModal=$uibModal.open({templateUrl:'static/templates/include/convert-to-list.html',scope:$scope,animation:!0,size:'md'})},$scope.closeConvertToListModal=function(){$scope.convertToListModal.dismiss()},$scope.closePreviewAnnotationModal=function(){$scope.annotationModal.dismiss()},$scope.updatePreviewAnnotation=function(){var oldAnnotation=$scope.annotationModalSettings.column.annotation;$scope.annotationModalSettings.column.annotation=$scope.annotationModalSettings.annotation,refreshPreviewFromCache(),$scope.annotationModal.dismiss(),pushUpdatePreviewAnnotation($scope.annotationModalSettings.column.name,oldAnnotation,$scope.annotationModalSettings.column.annotation)},$scope.deletePreviewAnnotation=function(){$scope.annotationModalSettings.column.annotation=null,refreshPreviewFromCache(),$scope.annotationModal.dismiss()},$scope.updateConvertToList=function(){$scope.convertToListModalSettings.column.splitOn=$scope.convertToListModalSettings.separator,$scope.api.preview(),$scope.convertToListModal.dismiss()},$scope.deleteConvertToList=function(){$scope.convertToListModalSettings.column.splitOn=null,$scope.api.preview(),$scope.convertToListModal.dismiss()},$scope.distinctModalSettings={columns:null,selected:null,notSelected:null,selectedColumn:null,add:function add(){$scope.distinctModalSettings.selectedColumn&&(_.remove($scope.distinctModalSettings.notSelected,function(col){return col.name==$scope.distinctModalSettings.selectedColumn.name}),$scope.distinctModalSettings.selected.push($scope.distinctModalSettings.selectedColumn))},remove:function remove(column){_.remove($scope.distinctModalSettings.selected,function(col){return col.name==column.name}),$scope.distinctModalSettings.notSelected.push(column),$scope.distinctModalSettings.notSelected=_.sortBy($scope.distinctModalSettings.notSelected,'id')}},$scope.showDistinctModal=function(columns,selectedColumnName){$scope.distinctModalSettings.columns=columns,$scope.distinctModalSettings.notSelected=[].concat(columns),$scope.distinctModalSettings.selected=[],$scope.distinctModalSettings.selectedColumn=_.find($scope.distinctModalSettings.notSelected,function(col){return col.name=selectedColumnName}),$scope.distinctModalSettings.add(),$scope.distinctModal=$uibModal.open({templateUrl:'static/templates/include/preview-distinct.html',scope:$scope,animation:!0,size:'md'})},$scope.closePreviewDistinctModal=function(){$scope.distinctModal.dismiss()},$scope.updatePreviewDistinct=function(){if($scope.distinctModalSettings.selected.length){var columnNames=_.map($scope.distinctModalSettings.selected,function(column){return column.name});$scope.addTransform({title:'Deduplicate',"@class":'.table.DeduplicationTransform',columnNames:columnNames})}$scope.distinctModal.dismiss(),$scope.api.preview()},$scope.setDataFormat=function(settings,filter){settings.formatSymbol=null;var oldData={filter:angular.copy(settings.filter),decimalPlaces:settings.decimalPlaces};filter?(settings.filter=filter,settings.decimalPlaces=2):(settings.filter=null,settings.decimalPlaces=null),refreshPreviewFromCache();var newData={filter:angular.copy(settings.filter),decimalPlaces:settings.decimalPlaces};pushSetDataFormat(settings.name,oldData,newData)},$scope.formatModalSettings={column:null,type:null,typeSelected:null,types:['','$','\u20AC','\xA3'],decimalPlaces:null,decimalPlacesAvailable:_.range(11)},$scope.showFormatModal=function(settings){$scope.formatModalSettings.column=settings,$scope.formatModalSettings.column.formatSymbol&&($scope.formatModalSettings.type=$scope.formatModalSettings.column.formatSymbol,$scope.formatModalSettings.typeSelected=$scope.formatModalSettings.column.formatSymbol),$scope.formatModalSettings.column.decimalPlaces&&($scope.formatModalSettings.decimalPlaces=+$scope.formatModalSettings.column.decimalPlaces),$scope.formatModal=$uibModal.open({templateUrl:'static/templates/include/preview-format.html',scope:$scope,animation:!0,size:'sm'})},$scope.closePreviewFormatModal=function(){$scope.formatModal.dismiss()},$scope.updatePreviewFormat=function(){var oldFormat={formatSymbol:angular.copy($scope.formatModalSettings.column.formatSymbol),decimalPlaces:angular.copy($scope.formatModalSettings.column.decimalPlaces),filter:angular.copy($scope.formatModalSettings.column.filter)};$scope.formatModalSettings.column.formatSymbol=$scope.formatModalSettings.type,$scope.formatModalSettings.column.decimalPlaces=0==$scope.formatModalSettings.decimalPlaces?'0':$scope.formatModalSettings.decimalPlaces,$scope.formatModalSettings.column.filter='currency',refreshPreviewFromCache(),$scope.formatModal.dismiss();var newFormat={formatSymbol:angular.copy($scope.formatModalSettings.column.formatSymbol),decimalPlaces:angular.copy($scope.formatModalSettings.column.decimalPlaces),filter:angular.copy($scope.formatModalSettings.column.filter)};pushUpdatePreviewFormat($scope.formatModalSettings.column.name,oldFormat,newFormat)};$scope.showPreserveHistoryModal=function(settings,m){$scope.preserveHistoryModalSettings=getPreserveHistoryModalSettings(),$scope.preserveHistoryModalSettings.column=settings,$scope.preserveHistoryModalSettings.m=m;var ph=$scope.preserveHistoryModalSettings.column.preserveHistory;ph&&($scope.preserveHistoryModalSettings.retention.value=ph.retention.value,$scope.preserveHistoryModalSettings.retention.selectedPeriod=ph.retention.period),$scope.preserveHistoryModal=$uibModal.open({templateUrl:'static/templates/include/preserve-history.html',scope:$scope,animation:!0,size:'md'})},$scope.closePreserveHistoryModal=function(){$scope.preserveHistoryModal.dismiss()},$scope.updatePreserveHistory=function(){var settings=$scope.preserveHistoryModalSettings.column;settings.preserveHistory={retention:{value:$scope.preserveHistoryModalSettings.retention.value,period:$scope.preserveHistoryModalSettings.retention.selectedPeriod}},$scope.preserveHistoryModalSettings.m.icon='fa fa-fw fa-check',$scope.preserveHistoryModal.dismiss()},$scope.deletePreserveHistory=function(){$scope.preserveHistoryModalSettings.m.icon='fa fa-fw',$scope.preserveHistoryModalSettings.column.preserveHistory=null,$scope.preserveHistoryModal.dismiss()},$scope.selectedNode=null;var actualSelectedNode=null,previewRequestId=null,refreshPreviewFromCache=function(){var columns=$scope.selectedNode.model.get('settings').columns;_.each(lastPreviewResponse.descriptor.columns,function(col){col.settings=_.find(columns,{name:col.name})}),preparePreviewData(lastPreviewResponse)};$scope.renameIndex=function(){$scope.updateTable(!0)},$scope.closeIndex=function(){$scope.updateTable().then(function(){$scope.selectedTable=void 0,HistoryService.clear(),window.onbeforeunload=void 0,$state.go('main')})},$scope.updateTable=function(nameOnly){$scope.isUpdating=!0;var method='PUT',url='/api/tables/'+$scope.selectedTable.id;return $q(function(resolve,reject){nameOnly?$http({method:method,url:url,data:{name:$scope.selectedTable.name}}).success(function(data){resolve(data),$scope.selectedTable.uploads=data.uploads,$scope.isUpdating=!1}).error(function(e){reject(e),common.showError(e),$scope.isUpdating=!1}):(_.each($('body').find('.html.Link.link'),function(elm){$(elm).css({fill:'transparent',stroke:'transparent'})}),html2canvas($elm.find('#worksheet')[0],{onrendered:function onrendered(canvas){var contentBBox=paper.getContentBBox();if(0<contentBBox.width&&0<contentBBox.height){var ctx=canvas.getContext('2d'),delta=20,x1=0>contentBBox.x-delta?0:contentBBox.x-delta,y1=0>contentBBox.y-delta?0:contentBBox.y-delta,x2=contentBBox.x+contentBBox.width+delta>canvas.width?canvas.width:contentBBox.x+contentBBox.width+delta,y2=contentBBox.y+contentBBox.height+delta>canvas.height?canvas.height:contentBBox.y+contentBBox.height+delta,width=x2-x1,height=y2-y1;if(width>2*height){var errY=(width/2-height)/2;y1<errY&&(errY=y1),canvas.height-y2<errY&&(errY=canvas.height-y2),0<errY&&(y1-=errY,y2+=errY)}else{var errX=(2*height-width)/2;x1<errX&&(errX=x1),canvas.width-x2<errX&&(errX=canvas.width-x2),0<errX&&(x1-=errX,x2+=errX)}width=x2-x1,height=y2-y1;var cut=ctx.getImageData(x1,y1,width,height);canvas.width=x2-x1,canvas.height=y2-y1,ctx.putImageData(cut,0,0);var img=canvas.toDataURL('image/png');$scope.selectedTable.previewImage=img&&6<img.length?img:'data:image/png;base64,'}else $scope.selectedTable.previewImage='data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACwAAAAAAQABAAACAkQBADs=';$scope.selectedTable.flowJSON=serializeGraph(),$http({method:method,url:url,data:{name:$scope.selectedTable.name,flowJSON:$scope.selectedTable.flowJSON,previewImage:$scope.selectedTable.previewImage}}).success(function(data){resolve(data),$scope.selectedTable.uploads=data.uploads,$scope.isUpdating=!1}).error(function(e){reject(e),common.showError(e),$scope.isUpdating=!1})}}))})},$scope.dropdownMenu={status:!1,mouseOverButton:!1,mouseOverList:!1,toggle:function toggle(){$scope.dropdownMenu.mouseOverButton||($scope.dropdownMenu.mouseOverButton=!0,$timeout(function(){!$scope.dropdownMenu.status&&$scope.dropdownMenu.mouseOverButton&&($scope.dropdownMenu.status=!0)},500))},close:function close(){$timeout(function(){$scope.dropdownMenu.mouseOverButton||$scope.dropdownMenu.mouseOverList||($scope.dropdownMenu.status=!1)},1e3)}},WSocket.subscribe('/upload-events',function(e){var node=_.find(graph.getElements(),function(elm){return e.file.type&&'composite-ds'!=e.file.type&&_.contains(elm.get('settings'),e.file.id)});if(node)switch(e.type){case'DELETE_FILE':node.remove();break;case'EDIT_FILE':node.get('view').label=e.file.name,node.findView(paper).updateBox();}}),$scope.viewMode=!1,$scope.$watch('viewMode',function(val){val&&(window.onbeforeunload=void 0,$state.go('main.visualize',{id:$scope.selectedTable.id}))}),$scope.$on('add-source',function(event,params){$scope.api.nodes.addSources(params.uploads)}),$scope.onWorkspaceResize=function(){$scope.api.resize($localStorage.workspaceH)},HistoryService.clear(),$(document).scrollTop(0),$(window).resize(function(){$scope.api.resize()});var indexes=DatadocService.getList();$scope.selectedTable=_.find(indexes,{id:parseInt($stateParams.id)}),$scope.api.load($scope.selectedTable),$stateParams.new&&($location.search('new',null).replace(),$timeout(function(){$elm.find('#status-bar').find('.form-control.selected').select()}))}}}])});
//# sourceMappingURL=../../../maps/modules/main/directives/ds-model.js.map
